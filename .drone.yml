kind: pipeline
type: docker
name: hs-frontend-ci

steps:
  # â€ä¾èµ–æ¨¡å—ç¼“å­˜â€œæ¢å¤
  - name: restore-cache
    pull: if-not-exists
    image: drillster/drone-volume-cache
    volumes:
      - name: node-modules-cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./node_modules

  # æ„å»ºå‰ç«¯
  - name: build-dist
    pull: if-not-exists
    image: node:16.13-alpine
    volumes:
      - name: frontend-temp
        path: /workspace
    commands:
      - npm install --registry=https://registry.npm.taobao.org
      - npm run build:prod
      - cp -r nginx/ /workspace
      - cp -r dist/ /workspace/dist_new
      - cp .env /workspace/.env
      - cp docker-compose.yml /workspace/docker-compose.yml
      - cp deploy.sh /workspace/deploy.sh

  # éƒ¨ç½²è¿è¡Œ
  - name: docker-deploy
    image: appleboy/drone-ssh # sshå·¥å…·é•œåƒ
    settings:
      host:
        from_secret: ssh_host
      username: root # è¿œç¨‹è¿æ¥è´¦å·
      password:
        from_secret: ssh_password # ä»Secretä¸­è¯»å–SSHå¯†ç 
      port: 22 # è¿œç¨‹è¿æ¥ç«¯å£
      command_timeout: 10m # è¿œç¨‹æ‰§è¡Œå‘½ä»¤è¶…æ—¶æ—¶é—´
      script_stop: false # è®¾ç½®ä¸ºfalseï¼Œé‡åˆ°ç¬¬ä¸€æ¬¡é”™è¯¯ä¼šç»§ç»­è¿è¡Œåé¢çš„å‘½ä»¤
      script:
        - cd /app/health-station/frontend # è¿›å…¥å®¿ä¸»æœºæ„å»ºç›®å½•,å¯æ ¹æ®è‡ªå·±é€‰æ‹©ç›®å½•
        - chmod +x deploy.sh # æ›´æ”¹ä¸ºå¯æ‰§è¡Œè„šæœ¬
        - ./deploy.sh # è¿è¡Œè„šæœ¬æ‰“åŒ…åº”ç”¨é•œåƒå¹¶è¿è¡Œ

  # é’‰é’‰é€šçŸ¥
  - name: dingtalk-notice
    image: lddsb/drone-dingtalk-message
    settings:
      token:
        from_secret: dingtalk_token
      secret:
        from_secret: dingtalk_secret
      type: markdown
      tips_title: hs-frontend-ci-info
      success_color: 09c270
      failure_color: ff3c3c
      tpl_build_status_success: "======== âˆš  SUCCESS ========"
      tpl_build_status_failure: "======== Ã—  FAILURE ========"
      debug: true
      tpl: |
        # <font color=[TPL_STATUS_COLOR]> [TPL_BUILD_STATUS] </font>

        ### ğŸ“ [TPL_REPO_SHORT_NAME]

        > ğŸ‘¨ [TPL_AUTHOR_NAME] | ğŸ”€ [TPL_COMMIT_BRANCH] | â±ï¸ `[TPL_BUILD_CONSUMING]s`
        ___

        ğŸ’¬ **Commit Message**

        > [TPL_COMMIT_MSG]
        ___

        ğŸ‘‡ **Detail**

        [ğŸ”— Committed Code Detail Page]([TPL_COMMIT_LINK])

        [ğŸ”— The Build Detail Page [TPL_STATUS_EMOTICON]]([TPL_BUILD_LINK])
        ___
    when:
      status: [ success,failure ]


  # â€œä¾èµ–æ¨¡å—ç¼“å­˜â€æ›´æ–°
  - name: rebuild-cache
    pull: if-not-exists
    image: drillster/drone-volume-cache
    volumes:
      - name: node-modules-cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - ./node_modules

volumes: # å®šä¹‰æµæ°´çº¿æŒ‚è½½ç›®å½•ï¼Œç”¨äºå…±äº«æ•°æ®
  - name: node-modules-cache
    host:
      path: /app/health-station/frontend/cache
  - name: frontend-temp
    host:
      path: /app/health-station/frontend

# droneæ‰§è¡Œè§¦å‘åˆ†æ”¯
trigger:
  branch:
    - master
  event:
    - push
